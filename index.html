<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trucksafe ELP Violation Analytics Dashboard</title>
  <link rel="icon" href="https://static.wixstatic.com/media/bb03f1_6b91954720844c2d88de1cdf16213d0c~mv2.png/v1/fill/w_32,h_32,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Trucksafe%20Badge.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    
    .stat-card { transition: all 0.3s ease; cursor: pointer; }
    .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(30, 58, 138, 0.15); }
    
    .timeline-event { position: relative; cursor: pointer; transition: all 0.2s ease; }
    .timeline-event:hover { transform: scale(1.1); }
    
    .tooltip-popup {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 12px;
      padding: 16px;
      background: white;
      border: 2px solid #1e3a8a;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 50;
      width: 280px;
      display: none;
    }
    
    .tooltip-popup.active { display: block; }
    
    .toggle-btn { transition: all 0.3s ease; }
    .toggle-btn.active { background: #1e3a8a; color: white; }
    
    .date-range-btn { transition: all 0.3s ease; }
    .date-range-btn.active { background: #1e3a8a; color: white; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.5s ease-out; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50">
  
  <!-- Header -->
  <div class="bg-gradient-to-r from-[#1e3a8a] to-[#0f172a] text-white shadow-xl">
    <div class="max-w-7xl mx-auto px-6 py-6">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-4">
          <img src="https://static.wixstatic.com/media/bb03f1_6b91954720844c2d88de1cdf16213d0c~mv2.png/v1/fill/w_96,h_60,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Trucksafe%20Badge.png" alt="Trucksafe" class="h-12">
          <div>
            <h1 class="text-2xl font-bold">ELP Out-of-Service Analytics</h1>
            <p class="text-sm text-blue-200">Real-time enforcement tracking • 49 CFR § 391.11(b)(2)</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="toggleView('oos')" id="btnOOS" class="toggle-btn active px-4 py-2 rounded-lg font-medium text-sm bg-white/20">
            OOS Only
          </button>
          <button onclick="toggleView('all')" id="btnAll" class="toggle-btn px-4 py-2 rounded-lg font-medium text-sm bg-white/10">
            All Violations
          </button>
        </div>
      </div>
      
      <!-- OOS Explanation Callout -->
      <div class="mt-4 bg-yellow-500/20 border border-yellow-400/50 rounded-lg p-3">
        <div class="flex items-start gap-2">
          <svg class="w-5 h-5 text-yellow-300 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          <div class="text-sm text-yellow-100">
            <strong>Note:</strong> While CVSA restored ELP to OOS criteria on June 25, 2025, not all ELP violations result in out-of-service orders. Violations in border zones and certain other circumstances may receive citations without immediate OOS placement.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-6 py-6">
    
    <!-- Sample Data Notice (hidden by default, shown only if sample data) -->
    <div id="sampleDataNotice" style="display: none;" class="mb-6 p-4 bg-amber-50 border-l-4 border-amber-500 rounded-r-lg">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <div>
          <h3 class="font-bold text-amber-900">Using Sample Data</h3>
          <p class="text-sm text-amber-800 mt-1">This dashboard is displaying sample data. Real FMCSA data will be loaded when available from the API.</p>
        </div>
      </div>
    </div>
    
    <!-- Data Freshness Notice -->
    <div class="mb-6 flex items-center justify-between bg-white rounded-lg shadow-sm px-4 py-3">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        <span class="text-sm text-gray-700">Data current as of <strong id="dataFreshnessDate">Loading...</strong></span>
      </div>
      <span class="text-xs text-gray-500">Source: FMCSA Data Portal</span>
    </div>

    <!-- Regulatory Timeline -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6 fade-in">
      <h3 class="text-lg font-bold text-gray-800 mb-6">Regulatory Timeline</h3>
      
      <!-- Timeline -->
      <div class="relative">
        <!-- Timeline line -->
        <div class="absolute top-8 left-0 right-0 h-1 bg-gradient-to-r from-blue-200 via-red-200 to-purple-200"></div>
        
        <!-- Timeline events -->
        <div class="relative flex justify-between">
          <!-- Event 1 -->
          <div class="timeline-event flex flex-col items-center z-10" onclick="toggleTooltip(event, 0)">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white shadow-lg">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <div class="mt-3 text-center">
              <div class="text-sm font-bold text-gray-700">2005</div>
              <div class="text-xs text-gray-500">CVSA Adds</div>
            </div>
            <div class="tooltip-popup">
              <div class="font-bold text-gray-900 mb-2">ELP Added to OOS Criteria</div>
              <p class="text-xs text-gray-700">CVSA incorporates English Language Proficiency into North American Standard Out-of-Service Criteria.</p>
              <a href="https://cvsa.org" target="_blank" class="text-xs text-blue-600 hover:underline mt-2 inline-block">Learn more →</a>
            </div>
          </div>

          <!-- Event 2 -->
          <div class="timeline-event flex flex-col items-center z-10" onclick="toggleTooltip(event, 1)">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-400 to-blue-500 flex items-center justify-center text-white shadow-lg">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
              </svg>
            </div>
            <div class="mt-3 text-center">
              <div class="text-sm font-bold text-gray-700">2016</div>
              <div class="text-xs text-gray-500">Removed</div>
            </div>
            <div class="tooltip-popup">
              <div class="font-bold text-gray-900 mb-2">ELP Removed from OOS</div>
              <p class="text-xs text-gray-700">Obama Administration removes ELP from out-of-service criteria, limiting enforcement options.</p>
              <a href="https://www.fmcsa.dot.gov" target="_blank" class="text-xs text-blue-600 hover:underline mt-2 inline-block">Learn more →</a>
            </div>
          </div>

          <!-- Event 3 -->
          <div class="timeline-event flex flex-col items-center z-10" onclick="toggleTooltip(event, 2)">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center text-white shadow-lg">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="mt-3 text-center">
              <div class="text-sm font-bold text-gray-700">Apr 2025</div>
              <div class="text-xs text-gray-500">Exec Order</div>
            </div>
            <div class="tooltip-popup">
              <div class="font-bold text-gray-900 mb-2">Executive Order 14286</div>
              <p class="text-xs text-gray-700">"Enforcing Commonsense Rules of the Road" directs FMCSA to restore ELP enforcement within 60 days.</p>
              <a href="https://www.whitehouse.gov" target="_blank" class="text-xs text-blue-600 hover:underline mt-2 inline-block">Read order →</a>
            </div>
          </div>

          <!-- Event 4 -->
          <div class="timeline-event flex flex-col items-center z-10" onclick="toggleTooltip(event, 3)">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-600 to-red-700 flex items-center justify-center text-white shadow-lg">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <div class="mt-3 text-center">
              <div class="text-sm font-bold text-gray-700">May 2025</div>
              <div class="text-xs text-gray-500">New Policy</div>
            </div>
            <div class="tooltip-popup">
              <div class="font-bold text-gray-900 mb-2">FMCSA Issues New Guidance</div>
              <p class="text-xs text-gray-700">FMCSA releases enforcement memo MC-SEE-2025-0001 with detailed assessment procedures for roadside inspections.</p>
              <a href="https://www.fmcsa.dot.gov/regulations" target="_blank" class="text-xs text-blue-600 hover:underline mt-2 inline-block">View guidance →</a>
            </div>
          </div>

          <!-- Event 5 -->
          <div class="timeline-event flex flex-col items-center z-10" onclick="toggleTooltip(event, 4)">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white shadow-lg">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <div class="mt-3 text-center">
              <div class="text-sm font-bold text-gray-700">Jun 2025</div>
              <div class="text-xs text-gray-500">OOS Restored</div>
            </div>
            <div class="tooltip-popup">
              <div class="font-bold text-gray-900 mb-2">CVSA Restores ELP to OOS</div>
              <p class="text-xs text-gray-700">Effective June 25, 2025, drivers failing ELP assessment can be placed out-of-service immediately.</p>
              <a href="https://cvsa.org/news/elp-oosc-06252025/" target="_blank" class="text-xs text-blue-600 hover:underline mt-2 inline-block">Read announcement →</a>
            </div>
          </div>

          <!-- Event 6 -->
          <div class="timeline-event flex flex-col items-center z-10" onclick="toggleTooltip(event, 5)">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
            </div>
            <div class="mt-3 text-center">
              <div class="text-sm font-bold text-gray-700">Dec 2025</div>
              <div class="text-xs text-gray-500">Codified</div>
            </div>
            <div class="tooltip-popup">
              <div class="font-bold text-gray-900 mb-2">Regulation Formally Updated</div>
              <p class="text-xs text-gray-700">FMCSA formally codifies ELP as out-of-service condition in 49 CFR 391.11(b)(2), making it permanent.</p>
              <a href="https://www.ecfr.gov/current/title-49/subtitle-B/chapter-III/subchapter-B/part-391" target="_blank" class="text-xs text-blue-600 hover:underline mt-2 inline-block">View regulation →</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-[#1e3a8a]">
        <div class="text-sm font-semibold text-gray-600 mb-1" id="statLabel">TOTAL OOS</div>
        <div class="text-3xl font-bold text-[#1e3a8a]" id="statOOS">527</div>
        <div class="text-xs text-gray-500 mt-1" id="statDateRange">Since Jan 25</div>
      </div>
      
      <div class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-orange-500">
        <div class="text-sm font-semibold text-gray-600 mb-1">MONTH OVER MONTH</div>
        <div class="text-3xl font-bold text-orange-500" id="statMoM">-4.4%</div>
        <div class="text-xs text-gray-500 mt-1" id="momLabel">Feb vs Jan 2026</div>
      </div>
      
      <div class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-green-600">
        <div class="text-sm font-semibold text-gray-600 mb-1">AVG PER MONTH</div>
        <div class="text-3xl font-bold text-green-600" id="statAvg">67</div>
        <div class="text-xs text-gray-500 mt-1">Last 9 months</div>
      </div>
      
      <div class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-blue-500">
        <div class="text-sm font-semibold text-gray-600 mb-1">PEAK MONTH</div>
        <div class="text-3xl font-bold text-blue-500" id="statPeak">Oct '25</div>
        <div class="text-xs text-gray-500 mt-1">73 violations</div>
      </div>
    </div>

    <!-- Main Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      
      <!-- Monthly Trend -->
      <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800" id="chartTitle">OOS Enforcement Trend</h3>
          <span class="text-xs text-gray-500" id="chartDateRange">Jan 2025 - Feb 2026</span>
        </div>
        <canvas id="trendChart" height="100"></canvas>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
          <p class="text-xs text-blue-900" id="keyInsight"><strong>Key Insight:</strong> Loading data...</p>
        </div>
      </div>
      
      <!-- US Heat Map - Plotly -->
      <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
        <h3 class="text-lg font-bold text-gray-800 mb-3">Geographic Heat Map</h3>
        
        <!-- Date Range Selector -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button onclick="updateMapDateRange('all')" id="dateAll" class="date-range-btn active text-xs px-3 py-1 rounded-lg bg-gray-100">
            Since Jan 25
          </button>
          <button onclick="updateMapDateRange('1m')" id="date1m" class="date-range-btn text-xs px-3 py-1 rounded-lg bg-gray-100">
            Last Month
          </button>
          <button onclick="updateMapDateRange('3m')" id="date3m" class="date-range-btn text-xs px-3 py-1 rounded-lg bg-gray-100">
            Last 3 Mo
          </button>
        </div>
        
        <!-- Plotly Map -->
        <div id="usMap" style="height: 350px;"></div>
        
        <div class="mt-3 text-xs text-gray-600 text-center font-semibold" id="mapDateLabel">
          Showing: All violations since Jan 25
        </div>
      </div>
    </div>

    <!-- Biggest Movers -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6 fade-in">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Biggest Movers - Month over Month</h3>
      <p class="text-sm text-gray-600 mb-4" id="biggestMoversSubtitle">States with largest change in OOS violations</p>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Top Increases -->
        <div>
          <h4 class="text-sm font-bold text-red-700 mb-3 flex items-center gap-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
            Largest Increases
          </h4>
          <div class="space-y-3" id="biggestIncreases">
            <p class="text-sm text-gray-500 text-center py-4">Loading...</p>
          </div>
        </div>
        
        <!-- Top Decreases -->
        <div>
          <h4 class="text-sm font-bold text-green-700 mb-3 flex items-center gap-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Largest Decreases
          </h4>
          <div class="space-y-3" id="biggestDecreases">
            <p class="text-sm text-gray-500 text-center py-4">Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Top 10 States -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6 fade-in">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Top 10 States by OOS Violations</h3>
      <div class="space-y-2" id="topStates">
        <p class="text-sm text-gray-500 text-center py-8">Loading...</p>
      </div>
    </div>

  </div>

  <script>
    let realData = null;
    let trendChart = null;
    let currentView = 'oos';
    let activeTooltip = null;
    let currentMapRange = 'all';
    
    // Sample data (fallback)
    const sampleData = {
      last_updated: "Sample Data",
      total_oos: 527,
      total_all: 1247,
      oos_rate: 42.3,
      avg_per_month: 67,
      peak_month: "Oct '25",
      peak_count: 73,
      mom_change: -4.4,
      monthly: {
        labels: ["Jun 25", "Jul 25", "Aug 25", "Sep 25", "Oct 25", "Nov 25", "Dec 25", "Jan 26", "Feb 26"],
        oos: [12, 23, 35, 51, 73, 68, 64, 59, 52],
        all: [28, 54, 82, 120, 173, 161, 151, 139, 123]
      },
      states: [
        { state: "CA", oos: 186, all: 440 },
        { state: "TX", oos: 171, all: 405 },
        { state: "FL", oos: 145, all: 343 },
        { state: "IL", oos: 98, all: 232 },
        { state: "GA", oos: 87, all: 206 },
        { state: "NY", oos: 76, all: 180 },
        { state: "PA", oos: 64, all: 151 },
        { state: "OH", oos: 53, all: 125 },
        { state: "NC", oos: 47, all: 111 },
        { state: "AZ", oos: 41, all: 97 }
      ],
      biggest_movers: {
        increases: [
          { state: "FL", change: 23.5, current: 42, previous: 34 },
          { state: "GA", change: 18.2, current: 26, previous: 22 },
          { state: "NC", change: 15.4, current: 15, previous: 13 }
        ],
        decreases: [
          { state: "CA", change: -12.3, current: 29, previous: 33 },
          { state: "TX", change: -8.7, current: 21, previous: 23 },
          { state: "IL", change: -6.5, current: 14, previous: 15 }
        ]
      },
      state_count: 45,
      data_source: "sample"
    };

    async function loadRealData() {
      try {
        const response = await fetch('elp_data.json');
        if (response.ok) {
          return await response.json();
        }
      } catch (e) {
        console.log('Using sample data');
      }
      return null;
    }

    async function initDashboard() {
      // Load real or sample data
      realData = await loadRealData() || sampleData;
      
      // Update data freshness notice
      const isSample = realData === sampleData;
      document.getElementById('dataFreshnessDate').textContent = realData.last_updated;
      
      if (isSample) {
        // Show sample data warning
        document.getElementById('sampleDataNotice').style.display = 'block';
      } else {
        // Hide sample data warning
        document.getElementById('sampleDataNotice').style.display = 'none';
      }
      
      // Initialize chart with real data
      initChart();
      
      // Update KPI cards
      updateKPIs();
      
      // Update biggest movers
      updateBiggestMovers();
      
      // Update top 10 states
      updateTopStates();
      
      // Initialize Plotly map
      initPlotlyMap();
      
      // Generate dynamic key insight
      updateKeyInsight();
    }

    function updateKPIs() {
      document.getElementById('statOOS').textContent = realData.total_oos.toLocaleString();
      document.getElementById('statMoM').textContent = (realData.mom_change > 0 ? '+' : '') + realData.mom_change + '%';
      document.getElementById('statAvg').textContent = realData.avg_per_month;
      document.getElementById('statPeak').textContent = realData.peak_month;
      
      // Calculate actual date range from data
      if (realData.monthly && realData.monthly.labels && realData.monthly.labels.length > 0) {
        const firstMonth = realData.monthly.labels[0];
        const lastMonth = realData.monthly.labels[realData.monthly.labels.length - 1];
        const dateRangeText = `${firstMonth} - ${lastMonth}`;
        
        // Update chart date range
        document.getElementById('chartDateRange').textContent = dateRangeText;
        
        // Update stat card date range (show start date only)
        document.getElementById('statDateRange').textContent = `Since ${firstMonth}`;
        
        // Update Month-over-Month label with actual months
        if (realData.monthly.labels.length >= 3) {
          // Using [-2] and [-3] for full months
          const lastFullMonth = realData.monthly.labels[realData.monthly.labels.length - 2];
          const previousFullMonth = realData.monthly.labels[realData.monthly.labels.length - 3];
          document.getElementById('momLabel').textContent = `${lastFullMonth} vs ${previousFullMonth}`;
          
          // Update biggest movers subtitle
          document.getElementById('biggestMoversSubtitle').textContent = 
            `States with largest change in OOS violations (${lastFullMonth} vs ${previousFullMonth})`;
        }
      }
    }

    function updateKeyInsight() {
      if (!realData || !realData.monthly || !realData.monthly.labels.length) {
        document.getElementById('keyInsight').innerHTML = '<strong>Key Insight:</strong> Loading data...';
        return;
      }
      
      const labels = realData.monthly.labels;
      const oosData = currentView === 'oos' ? realData.monthly.oos : realData.monthly.all;
      const peakMonth = realData.peak_month;
      const peakCount = realData.peak_count;
      
      // Find trend in recent months (last 3 months)
      const recentMonths = oosData.slice(-3);
      const trend = recentMonths[2] < recentMonths[1] ? 'decline' : recentMonths[2] > recentMonths[1] ? 'increase' : 'stabilization';
      const lastMonth = labels[labels.length - 1];
      
      const insight = `<strong>Key Insight:</strong> Peak enforcement occurred in ${peakMonth} (${peakCount.toLocaleString()} violations). Recent months show ${trend} with ${oosData[oosData.length - 1].toLocaleString()} violations in ${lastMonth}.`;
      
      document.getElementById('keyInsight').innerHTML = insight;
    }

    function updateBiggestMovers() {
      // Update increases
      const increasesHTML = realData.biggest_movers.increases.map(item => `
        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
          <div>
            <div class="font-bold text-gray-800">${item.state}</div>
            <div class="text-xs text-gray-600">${item.previous} → ${item.current} violations</div>
          </div>
          <div class="text-2xl font-bold text-red-600">+${item.change.toFixed(0)}%</div>
        </div>
      `).join('');
      
      // Update decreases
      const decreasesHTML = realData.biggest_movers.decreases.map(item => `
        <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
          <div>
            <div class="font-bold text-gray-800">${item.state}</div>
            <div class="text-xs text-gray-600">${item.previous} → ${item.current} violations</div>
          </div>
          <div class="text-2xl font-bold text-green-600">${item.change.toFixed(0)}%</div>
        </div>
      `).join('');
      
      document.getElementById('biggestIncreases').innerHTML = increasesHTML || '<p class="text-sm text-gray-500 text-center py-4">No significant changes</p>';
      document.getElementById('biggestDecreases').innerHTML = decreasesHTML || '<p class="text-sm text-gray-500 text-center py-4">No significant changes</p>';
    }

    function updateTopStates() {
      const topStatesHTML = realData.states.slice(0, 10).map((state, index) => {
        const maxOOS = realData.states[0].oos;
        const widthPercent = (state.oos / maxOOS) * 100;
        
        return `
          <div class="flex items-center gap-3 p-3 hover:bg-blue-50 rounded-lg transition">
            <div class="w-8 text-sm font-bold text-[#1e3a8a]">${index + 1}</div>
            <div class="w-12 text-sm font-bold text-gray-700">${state.state}</div>
            <div class="flex-1">
              <div class="h-8 bg-gradient-to-r from-[#1e3a8a] to-[#3b82f6] rounded-lg flex items-center px-3 text-white text-sm font-semibold" style="width: ${widthPercent}%;">${state.oos} OOS violations</div>
            </div>
            <div class="text-xs text-gray-500">${state.all} total</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('topStates').innerHTML = topStatesHTML;
    }

    function initChart() {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: realData.monthly.labels,
          datasets: [{
            label: 'OOS Violations',
            data: realData.monthly.oos,
            borderColor: '#1e3a8a',
            backgroundColor: 'rgba(30, 58, 138, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#1e3a8a',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#1e3a8a',
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  return 'OOS Violations: ' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0, 0, 0, 0.05)' },
              ticks: {
                font: { size: 11 },
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            },
            x: {
              grid: { display: false },
              ticks: { font: { size: 11 } }
            }
          }
        }
      });
    }

    function initPlotlyMap() {
      // Prepare data for Plotly
      const states = realData.states.map(s => s.state);
      const oosValues = realData.states.map(s => s.oos);
      const allValues = realData.states.map(s => s.all);
      
      // Hover text
      const hoverText = realData.states.map(s => 
        `${s.state}<br>OOS: ${s.oos.toLocaleString()}<br>Total: ${s.all.toLocaleString()}`
      );
      
      const data = [{
        type: 'choropleth',
        locationmode: 'USA-states',
        locations: states,
        z: oosValues,
        text: hoverText,
        hoverinfo: 'text',
        colorscale: [
          [0, '#eff6ff'],
          [0.2, '#dbeafe'],
          [0.4, '#93c5fd'],
          [0.6, '#3b82f6'],
          [0.8, '#1e40af'],
          [1, '#1e3a8a']
        ],
        colorbar: {
          title: 'OOS<br>Violations',
          thickness: 15,
          len: 0.7
        },
        marker: {
          line: {
            color: 'white',
            width: 1.5
          }
        }
      }];
      
      const layout = {
        geo: {
          scope: 'usa',
          showlakes: false,
          bgcolor: 'rgba(0,0,0,0)'
        },
        margin: { t: 0, b: 0, l: 0, r: 0 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {
          family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          size: 11
        }
      };
      
      const config = {
        responsive: true,
        displayModeBar: false
      };
      
      Plotly.newPlot('usMap', data, layout, config);
    }

    function toggleView(view) {
      currentView = view;
      
      document.getElementById('btnOOS').classList.toggle('active', view === 'oos');
      document.getElementById('btnAll').classList.toggle('active', view === 'all');
      
      if (view === 'oos') {
        // OOS view - update all metrics to show OOS data
        document.getElementById('statLabel').textContent = 'TOTAL OOS';
        document.getElementById('statOOS').textContent = realData.total_oos.toLocaleString();
        document.getElementById('chartTitle').textContent = 'OOS Enforcement Trend';
        
        trendChart.data.datasets[0].data = realData.monthly.oos;
        trendChart.data.datasets[0].label = 'OOS Violations';
        trendChart.data.datasets[0].backgroundColor = 'rgba(30, 58, 138, 0.1)';
        trendChart.data.datasets[0].borderColor = '#1e3a8a';
        
        // Update state rankings for OOS
        updateTopStates();
      } else {
        // All violations view - update all metrics to show total violation data
        document.getElementById('statLabel').textContent = 'TOTAL VIOLATIONS';
        document.getElementById('statOOS').textContent = realData.total_all.toLocaleString();
        document.getElementById('chartTitle').textContent = 'Violation Enforcement Trend';
        
        trendChart.data.datasets[0].data = realData.monthly.all;
        trendChart.data.datasets[0].label = 'All Violations';
        trendChart.data.datasets[0].backgroundColor = 'rgba(59, 130, 246, 0.1)';
        trendChart.data.datasets[0].borderColor = '#3b82f6';
        
        // Update state rankings for all violations (would need different data structure)
        updateTopStates();
      }
      
      trendChart.update();
      updateKeyInsight();
    }

    function updateMapDateRange(range) {
      currentMapRange = range;
      
      ['dateAll', 'date1m', 'date3m'].forEach(id => {
        document.getElementById(id).classList.remove('active');
      });
      
      const rangeMap = { 'all': 'dateAll', '1m': 'date1m', '3m': 'date3m' };
      document.getElementById(rangeMap[range]).classList.add('active');
      
      const labels = {
        'all': 'All violations since Jan 25',
        '1m': 'Last 30 days',
        '3m': 'Last 3 months'
      };
      document.getElementById('mapDateLabel').textContent = 'Showing: ' + labels[range];
    }

    // Timeline tooltip toggle
    function toggleTooltip(event, index) {
      event.stopPropagation();
      
      const tooltips = document.querySelectorAll('.tooltip-popup');
      const clickedTooltip = tooltips[index];
      
      // Close all other tooltips
      tooltips.forEach((tooltip, i) => {
        if (i !== index) {
          tooltip.classList.remove('active');
        }
      });
      
      // Toggle clicked tooltip
      clickedTooltip.classList.toggle('active');
      activeTooltip = clickedTooltip.classList.contains('active') ? clickedTooltip : null;
    }

    // Close tooltips when clicking outside
    document.addEventListener('click', function(event) {
      const tooltips = document.querySelectorAll('.tooltip-popup');
      tooltips.forEach(tooltip => {
        tooltip.classList.remove('active');
      });
      activeTooltip = null;
    });

    // Initialize dashboard on page load
    window.addEventListener('load', initDashboard);
  </script>

</body>
</html>
